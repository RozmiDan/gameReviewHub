# highload-2025

### Сервис мониторинга и отзывов об играх (GameReviewHub)

Проект представляет собой высоконагруженный сервис, предназначенный для создания, просмотра и обсуждения информации о видеоиграх. Пользователи могут создавать топики о новых играх, ставить оценки, оставлять комментарии, а также просматривать рейтинги и мнения других пользователей. Система реализована в микросервисной архитектуре, обеспечивая высокую производительность, масштабируемость и отказоустойчивость при высоких нагрузках.

### **Функциональность системы**

Создание и просмотр топиков игр
- Пользователи могут создавать новые топики для игр с указанием названия, описания, даты выхода и изображений.
- Доступна возможность просмотра списка всех игр и детальной информации по каждой из них.

Оценивание игр и комментарии
- Зарегистрированные пользователи могут поставить оценку игре и оставить свой комментарий.    
- Средний рейтинг игры рассчитывается автоматически и обновляется в реальном времени.

Просмотр рейтингов и комментариев
- Пользователи могут просматривать средний рейтинг и комментарии других пользователей по каждой игре. 
- Поддержка сортировки игр по рейтингу.

### **Компоненты проектируемой системы**

- **API (основной микросервис - MainService)**:
    - Go, REST API.
    - PostgreSQL – хранит данные игр, комментариев и пользователей.    

- **Сервис рейтингов (RatingService)**:
    - Go, gRPC.
    - PostgreSQL – хранение индивидуальных оценок.
    - Redis – кэширование рассчитанных средних рейтингов игр.

- **Брокер сообщений:**
    - Apache Kafka – асинхронная обработка событий (например, изменение рейтингов).

- **Балансировщик нагрузки:**
    - Nginx – управление и балансировка пользовательского трафика.

- **Мониторинг и логирование:**
    - ELK-стек (Elasticsearch, Logstash, Kibana) – обработка и визуализация логов.
    - Prometheus и Grafana – мониторинг в реальном времени, визуализация метрик производительности и доступности.

### **Ограничения проектируемой системы**

- **Максимальное количество пользователей**:
    - 6000 RPS.
    - До 2000 активно взаимодействующих пользователей одновременно (оценки, комментарии).
    
- **Производительность и время отклика**:
    - Время отклика REST API (MainService): ≤ 1000 мс для 95% запросов.
    - Запросы к PostgreSQL: ≤ 100 мс в 95% случаев.
    - gRPC-запросы между сервисами: ≤ 100 мс.
    - Асинхронные события в Kafka: latency ≤ 100-200 мс на доставку и обработку.


### **Требования к хранению и обработке данных**

- **Объем хранения данных на старте**:
    - Начальный объем: до 10 ГБ (игры, пользователи, комментарии, оценки).

- **Ожидаемый рост данных**:
    - Прирост: примерно 5-10 ГБ ежемесячно.
    - Ожидаемый объем данных за год: до ~100 ГБ, включая данные приложений и логи.

- **Требования к логированию**:
    - Прогнозируемый поток логов при пиковой нагрузке: до 50 записей в секунду (по ~500 байт каждая).
    - Средний дневной объем логов: около 1-3 ГБ в сутки.

User Case
![Описание](images/Pasted%20image%2020250415003917.png)

Non-UML
![Описание](images/Pasted%20image%2020250506101015.png)

***Нагрузочное тестирование***

Для тестирования нагрузочных возможностей приложения был выбран хендлер главной страницы, как самый ресурсозатратный. Данный хендлер проходит путь:
```
http request -> main_service -> grpc request -> rating_service -> db -> grpc response -> main_service -> db -> http response
```

1) Сценарий:
   - до 6000 пользователей
   - до 10000 RPS
   - ограничения контейнеров:
	   - rating service:
		   - 1.5 cpu
		   - 4 GB RAM
	   - main service:
		  - 2 cpu
		  - 4 GB RAM

Ограничения ресурсов контейнеров
![Описание](images/Pasted%20image%2020250526002104.png)

Выполняемый сценарий нагрузки
![Описание](images/Pasted%20image%2020250526001834.png)
Метрики сервисов при тестировании
![Описание](images/Pasted%20image%2020250526001859.png)

Пример 500 ошибки при загруженности сервера
![Описание](images/Pasted%20image%2020250526002147.png)

Отчет о выполнении теста
![Описание](images/Pasted%20image%2020250526002510.png)
20250526-0010

2) Сценарий:
   - до 5500 пользователей
   - до 10000 RPS
   - ограничения контейнеров:
	   - rating service:
		   - 1.5 cpu
		   - 2 GB RAM
	   - main service:
		  - 2 cpu
		  - 3 GB RAM

Выполняемый сценарий нагрузки
![Описание](images/Pasted%20image%2020250526122817.png)

Ограничения ресурсов контейнеров
![Описание](images/Pasted%20image%2020250526122758.png)

Метрики сервисов при тестировании
![Описание](images/Pasted%20image%2020250526122728.png)

Отчет о выполнении теста
![Описание](images/Pasted%20image%2020250526123003.png)
load-test/result/20250526-1221

3) Сценарий:
   - до 5500 пользователей
   - до 10000 RPS
   - ограничения контейнеров:
	   - rating service:
		   - 5 cpu
		   - 10 GB RAM
	   - main service:
		  - 5 cpu
		  - 10 GB RAM

Выполняемый сценарий нагрузки
![Описание](images/Pasted%20image%2020250526124328.png)

Ограничения ресурсов контейнеров
![Описание](images/Pasted%20image%2020250526124315.png)

Метрики сервисов при тестировании
![Описание](images/Pasted%20image%2020250526124253.png)

Отчет о выполнении теста
![Описание](images/Pasted%20image%2020250526124228.png)
20250526-1238

4) Сценарий:
   - до 5500 пользователей
   - до 10000 RPS
   - ограничения контейнеров:
	   - rating service:
		   - 3 cpu
		   - 3 GB RAM
	   - main service:
		  - 4 cpu
		  - 4 GB RAM

Ограничения ресурсов контейнеров
![Описание](images/Pasted%20image%2020250526125506.png)

Метрики сервисов при тестировании
![Описание](images/Pasted%20image%2020250526125433.png)

Отчет о выполнении теста
![Описание](images/Pasted%20image%2020250526125623.png)
20250526-1250

Как видно из тестов, лучше всего себя показала конфигурация со следующими параметрами:
	   - rating service:
		   - 3 cpu
		   - 3 GB RAM
	   - main service:
		  - 4 cpu
		  - 4 GB RAM

5) Дополнительно был проведен тест с повышенной нагрузкой 
Сценарий:
   - до 11000 пользователей
   - до 22000 RPS
   - ограничения контейнеров:
	   - rating service:
		   - 3 cpu
		   - 3 GB RAM
	   - main service:
		  - 4 cpu
		  - 4 GB RAM

Выполняемый сценарий нагрузки
![Описание](images/Pasted%20image%2020250526130427.png)

Ограничения ресурсов контейнеров
![Описание](images/Pasted%20image%2020250526130359.png)

Метрики сервисов при тестировании
![Описание](images/Pasted%20image%2020250526130237.png)

Отчет о выполнении теста
![Описание](images/Pasted%20image%2020250526130257.png)
20250526-1258

В результате были определены оптимальные ресурсы для контейнеров:
- rating service:
		   - 3 cpu
		   - 3 GB RAM
- main service:
		  - 4 cpu
		  - 4 GB RAM


***Горизонтальное масштабирование***

Для увеличения возможности по обработке клиентских запросов было принято решение горизонтально масштабировать main service в количестве 2 сервисов, так как большая часть нагрузки приходится на этот сервис. А для распределения нагрузки между получившимися инстансами поднять nginx. Для выбора оптимального алгоритма распределения запросов были проведены следующие тесты.

1) Round-Robin

Выполняемый сценарий нагрузки
![Описание](images/Pasted%20image%2020250526171948.png)

Метрики сервисов при тестировании
![Описание](images/Pasted%20image%2020250526171318.png)

Отчет о выполнении теста
![Описание](images/Pasted%20image%2020250526171538.png)
20250526-1708

2) Round-Robin

Выполняемый сценарий нагрузки
![Описание](images/Pasted%20image%2020250526172017.png)

Метрики сервисов при тестировании
![Описание](images/Pasted%20image%2020250526172216.png)

Отчет о выполнении теста
![Описание](images/Pasted%20image%2020250526172330.png)

20250526-1716

3) Least connections

Выполняемый сценарий нагрузки
![Описание](images/Pasted%20image%2020250526181106.png)

Метрики сервисов при тестировании
![Описание](images/Pasted%20image%2020250526181548.png)

Отчет о выполнении теста
![Описание](images/Pasted%20image%2020250526181646.png)****
20250526-1810

4) Random

Метрики сервисов при тестировании
![Описание](images/Pasted%20image%2020250526183728.png)

Отчет о выполнении теста
![Описание](images/Pasted%20image%2020250526183818.png)20250526-1832

Выводы: 
1) Оптимальные ресурсы:
   - для main_service: 4 CPU, 4 GB RAM
   - для rating_service: 3 CPU, 3 GB RAM
1) Алгоритм балансировки - Round Robin


6 ЛР
До начала 6 ЛР

Выполняемый сценарий нагрузки
![Описание](images/Pasted%20image%2020250526172017.png)

Метрики сервисов при тестировании
![Описание](images/Pasted%20image%2020250526172216.png)

Отчет о выполнении теста
![Описание](images/Pasted%20image%2020250526172330.png)

Для ускорения выдачи клиентам главной страницы, а также уменьшения нагрузки на систему, был внедрен Redis. Кэшируется главная страница сервиса. Для выбора времени кэширования были проведены следующие тесты.

1) Redis 30s

Метрики сервисов при тестировании
![Описание](images/Pasted%20image%2020250602231342.png)

Отчет о выполнении теста
![Описание](images/Pasted%20image%2020250602231757.png)

2) Redis 5s

Метрики сервисов при тестировании
![Описание](images/Pasted%20image%2020250602233432.png)

Отчет о выполнении теста
![Описание](images/Pasted%20image%2020250602234048.png)

Как видно из результатов тестирования - 5 секунд кэширования не является оптимальным временем кэширования. Был выбран отрезок в 30 секунд кэширования исходя из следующей логики - 30 секунд для обновления главной страницы не повлияют на пользовательский опыт, с другой стороны это позволит уменьшить нагрузку на систему.   

3) Репликация

Для повышения надежности сервиса, была добавлена реплика БД.

Метрики сервисов при тестировании
![Описание](images/Pasted%20image%2020250603113333.png)

Отчет о выполнении теста
![Описание](images/Pasted%20image%2020250603113603.png)

Из теста видно, что добавление реплики не повлияло на работу системы. 
## Запуск проекта

Для запуска системы используйте Docker Compose:

```bash
docker-compose up --build --scale main_service=2
```

Сервисы, которые будут подняты:
- `main_service` (REST API)
- `rating_service` (gRPC)
- `PostgreSQL`, `Redis`, `Kafka`, `Nginx`
- `Prometheus`, `Grafana`, `ELK`

## Структура проекта

```
.
├── main_service/          # REST API
├── rating_service/        # gRPC-сервис
├── gamehub-protos/        # Протоколы gRPC
├── docker-compose.yaml    # Docker-оркестрация
├── images/                # Скриншоты
└── README.md              # Описание проекта
```